#!/usr/bin/env node

"use strict";

var spawn = require('child_process').spawn,
    exec = require('child_process').exec,
    path = require('path'),
    fs = require('fs'),
    semverUtil = require('../lib/semver');
    
function error(msg) {
  console.error(msg);
  process.exit(-1);
} 

function getPkg() {
  var pkg;
  try {
    pkg = JSON.parse(fs.readFileSync(path.resolve(process.cwd(), './package.json')));
  } catch(e) {
    error('Could not open a package.json.');
  }
  return pkg;
};

function getCurrentVersion() {
  return getPkg().version;
};

var oldVersion = getCurrentVersion();

if (!oldVersion) error('No version in package.json found.');
var buildNumber = process.argv[2];
if (!buildNumber) error("No build number supplied.");

var semver = semverUtil.parseSemver(oldVersion);
if(!semver) error("Could not parse version from package.json");
let prereleaseTag = semver.release;
if(prereleaseTag) {
  //strip off everything after the first '.' (if present)
  prereleaseTag = prereleaseTag.split('.')[0];
} else {
  prereleaseTag = "SNAPSHOT";
}

semver.release = prereleaseTag + '.' + buildNumber;
var version = semverUtil.stringifySemver(semver);
const tag = semver.version + "-" + prereleaseTag;

// Run npm verison without tagging
var npm = spawn('npm', ['--no-git-tag-version', 'version', version]);
npm.stderr.pipe(process.stderr);

npm.on('close', function (code) {
  if (code !== 0) return error('npm version. Exiting.');
  process.stdout.write(tag);
  process.exit(0);
});

